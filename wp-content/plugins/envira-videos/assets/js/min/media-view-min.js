wp.media.view.EnviraVideosError=wp.Backbone.View.extend({tagName:"div",className:"envira-gallery-error envira-videos-error",render:function(){return this.template=wp.media.template("envira-videos-error"),this.$el.html(this.template(this.model)),this}}),wp.media.model.EnviraVideo=Backbone.Model.extend({defaults:{title:"",link:"",image:"",caption:"",alt:"",hosted_video:!1}}),wp.media.view.EnviraVideosItem=wp.Backbone.View.extend({tagName:"li",className:"attachment envira-videos-attachment",events:{"keyup input":"updateItem","change input":"updateItem","keyup textarea":"updateItem","change textarea":"updateItem","click .envira-videos-delete":"deleteItem"},initialize:function(){this.model.view=this},updateItem:function(e){this.model.set(e.target.name,e.target.value,{silent:!0}),"link"==e.target.name&&(this.model.set("link",e.target.value,{silent:!0}),""==e.target.value?this.model.set("hosted_video",!1):wp.media.ajax("envira_videos_is_hosted_video",{context:this,data:{nonce:envira_videos_media_view.nonce,video_url:e.target.value},success:function(e){e?(this.model.set("hosted_video",!0),this.model.view.$el.find("div.image").show()):(this.model.set("hosted_video",!1),this.model.view.$el.find("div.image").hide())},error:function(e){this.model.set("hosted_video",!1),void 0!==this.frame&&this.frame.content.get().trigger("loaded loaded:error",e)}})),this.model.get("hosted_video")?this.model.view.$el.find("div.image").show():this.model.view.$el.find("div.image").hide()},deleteItem:function(e){this.trigger("loading");var t=jQuery(e.target);t.parent().parent().parent().remove(),this.model.destroy(),this.trigger("loaded loaded:success")},render:function(){return this.template=wp.media.template("envira-videos-item"),this.$el.html(this.template(this.model.toJSON())),this}}),wp.media.view.Toolbar.EnviraVideos=wp.media.view.Toolbar.extend({initialize:function(){_.defaults(this.options,{event:"envira_videos_insert",close:!1,items:{envira_videos_insert:{id:"envira-videos-button",style:"primary",text:wp.media.view.l10n.insertIntoPost,priority:80,requires:!1,click:function(){this.controller.state().enviraVideosInsert()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments)},refresh:function(){this.get("envira_videos_insert").model.set("disabled",!1),wp.media.view.Toolbar.prototype.refresh.apply(this,arguments)}}),wp.media.view.EnviraVideos=wp.media.View.extend({events:{"click .envira-videos-add":"addItem","click .envira-insert-video":"insertVideo","click .envira-insert-placeholder":"insertPlaceholder","click .envira-item-collapse":"collapse","keyup input":"refreshView"},initialize:function(){this.collection=new Backbone.Collection,this.is_loading=!1,this.$el.prepend(wp.media.template("envira-videos-router")),this.$el.prepend(wp.media.template("envira-videos-side-bar")),this.$el.prepend(wp.media.template("envira-videos-items")),this.addItem(),this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),0=="ul.attachments.envira-videos-attachments".length&&this.$el.find(".envira-videos-add").click()},collapse:function(e){var t=$(this.$el);$text=t.find(".envira-item-collapse"),e.preventDefault(),t.find(".envira-item-setting").not(".title").is(":visible")?($text.text("Expand"),t.find(".envira-item-setting").not(".title").fadeOut()):($text.text("Collapse"),t.find(".envira-item-setting").not(".title").fadeIn())},loading:function(){this.is_loading=!0,this.$el.find(".spinner").addClass("is-active")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").removeClass("is-active"),this.$el.find("div.envira-gallery-error").remove(),"object"==typeof e&&(e=e.responseText),"undefined"!=typeof e&&(this.$el.find("div.media-toolbar").after(this.renderError(e)),this.$el.find("ul.attachments.envira-videos-attachments").css("margin-top",this.$el.find("div.envira-gallery-error").height()+20)),this.controller.toolbar.get().refresh()},insertVideo:function(e){var t,i=e;$model=this.model,$this=$(this.$el),e.preventDefault();var n=$(e.currentTarget),a=n.parent().parent().find("input");return t?void t.open():(t=wp.media.frames.envira_video_frame=wp.media({frame:"select",library:{type:"video"},title:"Select A Video",button:{text:"Submit"},contentUserSetting:!1,multiple:!1}),t.on("select",function(){attachment=t.state().get("selection").first().toJSON(),$value=a.val(attachment.url),a.change()}),void t.open())},insertPlaceholder:function(e){var t,i=this.model;e.preventDefault();var n=$(e.currentTarget),a=n.parent().parent().find("input");return t?void t.open():(t=wp.media.frames.envira_placeholder_frame=wp.media({frame:"select",library:{type:"image"},title:"Select An Image",button:{text:"Submit"},contentUserSetting:!1,multiple:!1}),t.on("select",function(){attachment=t.state().get("selection").first().toJSON(),a.val(attachment.url),a.change()}),void t.open())},clearItems:function(){this.$el.find("ul.envira-videos-attachments").empty()},renderError:function(e){var t={};t.error=e;var i=new wp.media.view.EnviraVideosError({model:t});return i.render().el},addItem:function(e){this.trigger("loading"),model=new wp.media.model.EnviraVideo,this.getSelection().add(model);var t=new wp.media.view.EnviraVideosItem({model:model,controller:this});this.$el.find("ul.envira-videos-attachments").append(t.render().el),this.trigger("loaded loaded:success")},refreshView:function(e){this.model.each(function(e){e.get("hosted_video")?e.view.$el.find("div.image").fadeIn():e.view.$el.find("div.image").fadeOut()})},getSelection:function(){return this.controller.state().props},clearSelection:function(){this.selection=this.getSelection(),jQuery("li.attachment.envira-videos-attachment").remove(),this.selection.reset()}});var envira_videos_post_frame=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=envira_videos_post_frame.extend({initialize:function(){envira_videos_post_frame.prototype.initialize.apply(this,arguments),this.states.add([new wp.media.controller.EnviraVideos({id:"envira-videos",content:"envira-videos-content",toolbar:"envira-videos-toolbar",menu:"default",title:wp.media.view.l10n.enviraVideosTitle,priority:200,type:"link"})]),this.on("content:render:envira-videos-content",this.renderEnviraVideosContent,this),this.on("toolbar:create:envira-videos-toolbar",this.createEnviraVideosToolbar,this)},renderEnviraVideosContent:function(){this.content.set(new wp.media.view.EnviraVideos({controller:this,model:this.state().props,className:"attachments-browser envira-gallery envira-videos"}))},createEnviraVideosToolbar:function(e){e.view=new wp.media.view.Toolbar.EnviraVideos({controller:this})}}),wp.media.controller.EnviraVideos=wp.media.controller.State.extend({initialize:function(e){this.props=new Backbone.Collection},enviraVideosInsert:function(){var e=this.frame.content.get(),t=[],i=!0;return this.button=this.frame.toolbar.get().get("envira_videos_insert"),this.button.model.set("text",wp.media.view.l10n.inserting),this.button.model.set("disabled",!0),e.trigger("loading"),e.getSelection().each(function(e){""==e.get("title")&&(i=!1),""==e.get("url")&&(i=!1),e.get("hosted_video")&&""==e.get("image")&&(i=!1),t.push(e.toJSON())},this),i?void wp.media.ajax("envira_videos_insert_videos",{context:this,data:{nonce:envira_videos_media_view.nonce,post_id:envira_videos_media_view.post_id,videos:t},success:function(t){jQuery("#envira-gallery-output").html(t),e.trigger("loaded loaded:success"),this.button.model.set("text",wp.media.view.l10n.insertIntoPost),this.button.model.set("disabled",!1),e.clearSelection(),jQuery(document).trigger("enviraInsert"),this.frame.close()},error:function(t){this.button.model.set("text",wp.media.view.l10n.insertIntoPost),this.button.model.set("disabled",!1),e.trigger("loaded loaded:error",t)}}):(e.trigger("loaded loaded:error",wp.media.view.l10n.enviraVideosValidationError),this.button.model.set("text",wp.media.view.l10n.insertIntoPost),this.button.model.set("disabled",!1),!1)}});